@page "/photos"
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JS
@using FinalProjApp.Data
@using FinalProjApp.Models
@inject PhotoContext Db

<h3>Upload Photos</h3>

<InputFile OnChange="HandleFileUpload" multiple />

@if (ImageUrls.Any())
{
    <div class="photo-grid">
        @foreach (var url in ImageUrls)
        {
            <img src="@url" class="photo-item" />
        }
    </div>
}

@code {
    private List<string> ImageUrls = new();

    protected override async Task OnInitializedAsync()
    {
        var photos = await Db.Photos.ToListAsync();

        ImageUrls = photos.Select(p =>
            $"data:{p.ContentType};base64,{Convert.ToBase64String(p.Data)}"
        ).ToList();
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);

            var photo = new Photo
            {
                FileName = file.Name,
                ContentType = file.ContentType,
                Data = buffer
            };

            Db.Photos.Add(photo);
            await Db.SaveChangesAsync();

            var base64 = Convert.ToBase64String(buffer);
            var imageUrl = $"data:{file.ContentType};base64,{base64}";
            ImageUrls.Add(imageUrl);
        }
    }
}